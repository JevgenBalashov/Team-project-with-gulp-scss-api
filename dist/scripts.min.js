let cardElem,input_search__title=document.querySelector(".search__title"),value_search__title,select_search__doctor=document.querySelector(".search__doctor"),value_search__doctor,select_search__urgency=document.querySelector(".search__urgency"),value_search__urgency;class App{constructor(){this.loginButton=document.getElementById("login__button"),this.loginForm=document.querySelector(".login__form"),this.createVisitButton=document.querySelector(".header_btn.second__btn"),this.closeIcon=document.querySelector(".close-icon"),this.logOutButton=document.getElementById("logout__button"),this.visitWindow=document.querySelector(".visit__window"),this.closeVisitWindow=document.querySelector(".icon-close"),this.emailInput=document.getElementById("email"),this.passwordInput=document.getElementById("password"),this.registerForm=document.querySelector(".register__form"),this.registerEmailInput=document.getElementById("register-email"),this.registerPasswordInput=document.getElementById("register-password"),this.initialize()}initialize(){this.addEventListeners(),this.checkAuthentication()}addEventListeners(){this.visitWindow.addEventListener("click",e=>{e.target!==document.querySelector(".visit__window")&&!e.target.classList.contains("fa-xmark")||(document.querySelector(".visit__edit-btn").style.display="none",document.querySelector("button.visit__create-btn").style.display="block",document.querySelector("span.visit__form-title").textContent="Створити візит",this.visitWindow.style.display="none",document.body.style.overflow="")}),this.createVisitButton.addEventListener("click",()=>{window.scrollTo(0,0),this.visitWindow.style.display="block",document.body.style.overflow="hidden"}),this.loginButton.addEventListener("click",()=>{window.scrollTo(0,0),this.loginForm.style.display="block",document.body.style.overflow="hidden"}),this.loginForm.addEventListener("submit",e=>{document.body.style.overflow="",e.preventDefault(),this.handleLoginFormSubmit()}),this.logOutButton.addEventListener("click",()=>{this.logout()}),this.loginForm.addEventListener("click",e=>{e.target!==document.querySelector("div.form__baground")&&!e.target.classList.contains("fa-xmark")||(this.loginForm.style.display="none",document.body.style.overflow="")}),this.registerForm&&this.registerForm.addEventListener("submit",e=>{document.body.style.overflow="",e.preventDefault(),this.handleRegisterFormSubmit()})}checkAuthentication(){this.isAuthenticated()?this.showLoggedInState():this.showLoggedOutState()}handleLoginFormSubmit(){var e=this.emailInput.value,t=this.passwordInput.value;this.login(e,t).then(e=>{e&&(console.log("Користувач успішно авторизований!"),this.loginForm.style.display="none",this.showLoggedInState())}).catch(e=>{console.log("Помилка при авторизації: "+e.message)})}handleRegisterFormSubmit(){var e=this.registerEmailInput.value,t=this.registerPasswordInput.value;this.register(e,t).then(e=>{e&&console.log("Користувач успішно зареєстрований!")}).catch(e=>{console.log("Помилка при реєстрації: "+e.message)})}login(e,t){return fetch("https://ajax.test-danit.com/api/v2/cards/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}).then(e=>{if(e.ok)return e.text();throw e="Помилка при отриманні токена: "+e.status,new Error(e)}).then(e=>(this.saveToken(e),!0)).catch(e=>{throw new Error("Помилка при виконанні запиту: "+e)})}register(e,t){return fetch("https://ajax.test-danit.com/api/v2/cards",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}).then(e=>e.ok?e.text():e.text().then(e=>{throw new Error(e)})).then(e=>(this.saveToken(e),!0)).catch(e=>{throw new Error("Помилка при виконанні запиту: "+e)})}logout(){document.getElementById("root").innerHTML='<span class="visit__cards-notification">no items have been added</span>',this.removeToken(),console.log("Користувач вийшов з аккаунту"),this.showLoggedOutState()}saveToken(e){localStorage.setItem("token",e)}getToken(){return localStorage.getItem("token")}removeToken(){localStorage.removeItem("token")}isAuthenticated(){var e=this.getToken();return null!=e}showLoggedInState(){getAllCards(),this.loginButton.style.display="none",this.createVisitButton.style.display="inline-block",this.logOutButton.style.display="block"}showLoggedOutState(){this.loginButton.style.display="block",this.createVisitButton.style.display="none",this.logOutButton.style.display="none"}}const app=new App;class Modal{constructor(){this.isEditing=!1,this.additionalData=!1,this.editBtn=document.querySelector(".visit__edit-btn"),this.cardiologistFields={typicalPressure:document.querySelector(".visit__info-typical-pressure"),bodyMassIndex:document.querySelector(".visit__info-body-mass-index"),heartDiseases:document.querySelector(".visit__info-heart-diseases"),ageCardiologist:document.querySelector(".visit__info-age-cardiologist")},this.dentistFields={lastVisitDate:document.querySelector(".visit__info-last-visit-date")},this.therapistFields={ageTherapist:document.querySelector(".visit__info-age-therapist")},document.querySelector(".visit__info-doctor").addEventListener("change",()=>{var e=document.querySelector(".visit__info-doctor").value;this.hideCardiologistFields(),this.hideDentistFields(),this.hideTherapistFields(),"cardiologist"===e?this.showFields(this.cardiologistFields):"dentist"===e?this.showFields(this.dentistFields):"therapist"===e&&this.showFields(this.therapistFields)}),document.querySelector(".visit__create-btn").addEventListener("click",e=>{var t,i,s,o,a;e.preventDefault(),this.allFieldsAreFilled()?(input_search__title.value="",select_search__doctor.value=null,select_search__urgency.value=null,value_search__doctor=null,value_search__urgency=null,value_search__title="",document.querySelector(".visit__window").style.display="none",document.body.style.overflow="",e=document.querySelector(".visit__info-fullname").value,t=document.querySelector(".visit__info-doctor").value,i=document.querySelector(".visit__info-purpose").value,s=document.querySelector(".visit__info-description").value,o=document.querySelector(".visit__info-urgency").value,a={},"cardiologist"===t?(a.bp=this.cardiologistFields.typicalPressure.value,a.bodyMassIndex=this.cardiologistFields.bodyMassIndex.value,a.heartDiseases=this.cardiologistFields.heartDiseases.value,a.age=this.cardiologistFields.ageCardiologist.value):"dentist"===t?a.lastVisitDate=this.dentistFields.lastVisitDate.value:"therapist"===t&&(a.age=this.therapistFields.ageTherapist.value),e={clientName:e,doctor:t,description:i+" - "+s,urgency:o,...a},fetch("https://ajax.test-danit.com/api/v2/cards",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{document.querySelector(".visit__cards-notification").style.display="none",this.showCard(e),this.setupEventListeners(cardElem,e.id,e),console.log(e)}).catch(e=>{console.error("Помилка при виконанні POST запиту:",e)})):alert("Будь ласка, заповніть усі поля форми!")})}allFieldsAreFilled(){var e;for(e of document.querySelectorAll(".visit-info--showed"))if(!e.value||"null"===e.value)return!1;return!0}hideCardiologistFields(){Object.values(this.cardiologistFields).forEach(e=>{e.style.display="none",e.classList.remove("visit-info--showed")})}hideDentistFields(){Object.values(this.dentistFields).forEach(e=>{e.style.display="none",e.classList.remove("visit-info--showed")})}hideTherapistFields(){Object.values(this.therapistFields).forEach(e=>{e.style.display="none",e.classList.remove("visit-info--showed")})}showFields(e){Object.values(e).forEach(e=>{e.style.display="block",e.classList.add("visit-info--showed")})}handleEditButtonClick=(e,t)=>{var i,s,o,a,n;t.preventDefault(),this.isEditing||(this.allFieldsAreFilled()?(this.isEditing=!0,console.log(e),t=document.querySelector(".visit__info-fullname").value,i=document.querySelector(".visit__info-doctor").value,s=document.querySelector(".visit__info-purpose").value,o=document.querySelector(".visit__info-description").value,a=document.querySelector(".visit__info-urgency").value,n={},"cardiologist"===i?(n.bp=this.cardiologistFields.typicalPressure.value,n.bodyMassIndex=this.cardiologistFields.bodyMassIndex.value,n.heartDiseases=this.cardiologistFields.heartDiseases.value,n.age=this.cardiologistFields.ageCardiologist.value):"dentist"===i?n.lastVisitDate=this.dentistFields.lastVisitDate.value:"therapist"===i&&(n.age=this.therapistFields.ageTherapist.value),t={clientName:t,doctor:i,description:s+" - "+o,urgency:a,...n},fetch("https://ajax.test-danit.com/api/v2/cards/"+e,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{this.isEditing=!1,document.querySelector("button.visit__create-btn").style.display="block",this.editBtn.style.display="none",document.querySelector("span.visit__form-title").textContent="Створити візит",document.querySelector(".visit__window").style.display="none",document.body.style.overflow="",cardElem.style.display="none",this.showCard(e),this.setupEventListeners(cardElem,e.id,e),console.log("Put запит пройшов успішно!"),console.log(e)}).catch(e=>{this.isEditing=!1,console.log("Помилка при виконанні PUT запиту: ",e)})):alert("Будь ласка, заповніть усі поля форми!"))};setupEventListeners(l,r,d){l.addEventListener("click",e=>{var t,i,s,o,a,n;e.target.classList.contains("fa-trash")?(document.getElementById("root").removeChild(l),fetch("https://ajax.test-danit.com/api/v2/cards/"+r,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}}).then(()=>{console.log(`Картка з id '${r}' була успішно видалена`),1===document.getElementById("root").children.length&&(document.querySelector(".visit__cards-notification").style.display="block")}).catch(e=>{console.error("Помилка при видаленні карти: ",e)})):e.target.classList.contains("fa-note-sticky")?(window.scrollTo(0,0),document.querySelector(".visit__window").style.display="block",document.querySelector("button.visit__create-btn").style.display="none",this.editBtn.style.display="block",document.body.style.overflow="hidden",document.querySelector("span.visit__form-title").textContent="Редагувати дані про візит",this.isEditing||this.editBtn.addEventListener("click",e=>this.handleEditButtonClick(r,e))):e.target.classList.contains("fa-circle-info")&&(this.additionalData?(l.querySelectorAll(".card__doc-profile.card__doc-profile--additional").forEach(e=>{e.style.display="none"}),this.additionalData=!1):(e=document.createElement("h3"),t=document.createElement("h3"),i=document.createElement("h3"),s=document.createElement("h3"),o=document.createElement("h3"),a=document.createElement("h3"),n=document.createElement("h3"),d.description&&(e.style.paddingTop="10px",e.textContent="Description of visit: "+d.description,e.classList.add("card__doc-profile"),e.classList.add("card__doc-profile--additional")),d.bp&&(t.style.paddingTop="10px",t.textContent="Typical pressure: "+d.bp,t.classList.add("card__doc-profile"),t.classList.add("card__doc-profile--additional")),d.age&&(i.style.paddingTop="10px",i.textContent="Age of client: "+d.age,i.classList.add("card__doc-profile"),i.classList.add("card__doc-profile--additional")),d.lastVisitDate&&(s.style.paddingTop="10px",s.textContent="Last visit: "+d.lastVisitDate,s.classList.add("card__doc-profile"),s.classList.add("card__doc-profile--additional")),d.bodyMassIndex&&(o.style.paddingTop="10px",o.textContent="Body mass index: "+d.bodyMassIndex,o.classList.add("card__doc-profile"),o.classList.add("card__doc-profile--additional")),d.heartDiseases&&(a.style.paddingTop="10px",a.textContent="Heart diseases: "+d.heartDiseases,a.classList.add("card__doc-profile"),a.classList.add("card__doc-profile--additional")),d.urgency&&(n.style.paddingTop="10px",n.textContent="Urgency of the visit: "+d.urgency,n.classList.add("card__doc-profile"),n.classList.add("card__doc-profile--additional")),l.append(e),l.append(t),l.append(i),l.append(s),l.append(o),l.append(a),l.append(n),this.additionalData=!0))})}showCard(e){var t=document.getElementById("root"),i=document.createElement("div"),s=(i.classList.add("card"),document.createElement("h1")),s=(s.classList.add("card__title"),s.textContent=e.clientName,i.append(s),document.createElement("h3")),e=(s.classList.add("card__doc-profile"),s.textContent=e.doctor,i.append(s),document.createElement("div"));e.classList.add("card__btn"),e.innerHTML=`<button class="card__btn-optional card__btn-more-info"><i class="fa-solid fa-circle-info"></i></button>
    <button class="card__btn-optional card__btn-edit-info"><i class="fa-solid fa-note-sticky"></i></button>
    <button class="card__btn-optional card__btn-delete"><i class="fa-solid fa-trash"></i></button>`,i.append(e),t.prepend(i),cardElem=i}}function printCard(e,t){var i=document.getElementById("root"),s=document.createElement("div"),o=(s.classList.add("card"),document.createElement("h1")),o=(o.classList.add("card__title"),o.textContent=e.clientName,s.append(o),document.createElement("h3")),o=(o.classList.add("card__doc-profile"),o.textContent=e.doctor,s.append(o),document.createElement("div"));return o.classList.add("card__btn"),o.innerHTML=`<button class="card__btn-optional card__btn-more-info"><i class="fa-solid fa-circle-info"></i></button>
  <button class="card__btn-optional card__btn-edit-info"><i class="fa-solid fa-note-sticky"></i></button>
  <button class="card__btn-optional card__btn-delete"><i class="fa-solid fa-trash"></i></button>`,s.append(o),i.prepend(s),cardElem=s,t.setupEventListeners(s,e.id,e),s}function getAllCards(){return fetch("https://ajax.test-danit.com/api/v2/cards",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}}).then(e=>e.json()).then(e=>{const t=new Modal;0===e.length?document.querySelector(".visit__cards-notification").style.display="block":document.querySelector(".visit__cards-notification").style.display="none",document.querySelectorAll(".card").forEach(e=>{e.remove()});let i=!1;e.forEach(e=>{""!=value_search__title||null!=value_search__doctor&&"null"!=value_search__doctor||null!=value_search__urgency&&"null"!=value_search__urgency||(t.editingCard=!1,printCard(e,t),i=!0),""!=value_search__title?-1!=e.clientName.replaceAll(" ","").toLowerCase().search(value_search__title)?(t.editingCard=!1,printCard(e,t),i=!0):(console.log(e.clientName.replaceAll(" ","").toLowerCase()),console.log(value_search__title)):null!=value_search__doctor?-1!=e.doctor.search(value_search__doctor)&&(t.editingCard=!1,printCard(e,t),i=!0):null!=value_search__urgency&&-1!=e.urgency.search(value_search__urgency)&&(t.editingCard=!1,printCard(e,t),i=!0)}),i?(document.querySelector(".visit__cards-notification").textContent="no items have been added",document.querySelector(".visit__cards-notification").style.display="none"):(document.querySelector(".visit__cards-notification").style.display="block",document.querySelector(".visit__cards-notification").textContent="There are no cards that match this filter"),console.log(e)}).catch(e=>console.log("An error occured while fetching all cards from server: ",e))}input_search__title.oninput=function(){value_search__title=this.value.replaceAll(" ","").toLowerCase(),select_search__doctor.value=null,select_search__urgency.value=null,value_search__doctor=null,value_search__urgency=null,getAllCards()},select_search__doctor.addEventListener("change",()=>{value_search__doctor=select_search__doctor.value,input_search__title.value="",select_search__urgency.value=null,value_search__title="",value_search__urgency=null,getAllCards()}),select_search__urgency.addEventListener("change",()=>{value_search__urgency=select_search__urgency.value,input_search__title.value="",select_search__doctor.value=null,value_search__title="",value_search__doctor=null,getAllCards()});